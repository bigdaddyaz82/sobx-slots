<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Carnival - Connect Wallet</title>
</head>
<body>
  <h1>Welcome to the Crypto Carnival!</h1>
  <button id="connectButton">Connect MetaMask Wallet</button>
  
  <p id="walletAddress">Not connected</p>
  <p id="rewardMessage"></p>

  <script src="frontend.js"></script>
</body>
</html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOBEX Slots - Old School Style</title>
  <style>
    body {
      background: #222;
      font-family: 'Courier New', Courier, monospace;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .slot-machine {
      position: relative;
      width: 320px;
      background: #444;
      border: 5px solid #aaa;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 20px #f00 inset;
    }
    /* Red blinking light on top */
    .red-light {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      background: red;
      border-radius: 50%;
      box-shadow: 0 0 15px 5px red;
      opacity: 0.2;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    .red-light.active {
      opacity: 1;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% {opacity: 1;}
      50% {opacity: 0.2;}
    }

    /* Display reels */
    #spinResult {
      font-size: 2.2rem;
      text-align: center;
      margin: 10px 0 20px 0;
      letter-spacing: 1.2rem;
      font-weight: bold;
      font-family: 'Courier New', Courier, monospace;
    }

    /* Buttons container */
    .buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    /* Connect wallet button */
    #connectWallet {
      background: #0077ff;
      color: white;
      border: none;
      padding: 12px 18px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      flex: 1;
      margin-right: 10px;
      transition: background 0.3s;
    }
    #connectWallet:hover {
      background: #005bb5;
    }

    /* Big red spin button */
    #spinButton {
      background: #e00;
      color: white;
      border: none;
      padding: 18px 28px;
      font-size: 2rem;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      flex: 1;
      margin-left: 10px;
      box-shadow: 0 0 15px #f00;
      transition: background 0.3s;
    }
    #spinButton:hover {
      background: #a00;
      box-shadow: 0 0 25px #f33;
    }

    /* Lever container */
    .lever-container {
      position: absolute;
      top: 40px;
      right: -70px;
      width: 50px;
      height: 150px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Lever arm */
    .lever-arm {
      background: #bbb;
      width: 12px;
      height: 100px;
      border-radius: 8px;
      box-shadow: inset 0 0 5px #666;
      position: relative;
      transition: transform 0.2s ease;
    }
    /* Lever knob */
    .lever-knob {
      background: #c33;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-top: -20px;
      box-shadow: 0 0 8px #f00;
    }

    /* Lever pull animation */
    .lever-pulled {
      transform: rotate(45deg);
      transition: transform 0.2s ease;
    }

    /* Wallet address display */
    #walletAddress {
      margin-top: 10px;
      font-size: 0.9rem;
      font-family: monospace;
      min-height: 1.3rem;
    }
  </style>
</head>
<body>

  <div class="slot-machine">
    <div class="red-light" id="redLight"></div>

    <div id="spinResult">- - -</div>

    <div class="buttons">
      <button id="connectWallet">Connect Wallet</button>
      <button id="spinButton">SPIN</button>
    </div>

    <div id="walletAddress"></div>

    <div class="lever-container" id="lever" title="Pull lever to spin">
      <div class="lever-arm"></div>
      <div class="lever-knob"></div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="spinSound" src="https://actions.google.com/sounds/v1/casino/slot_machine_spin.ogg" preload="auto"></audio>
  <audio id="winSound" src="https://actions.google.com/sounds/v1/casino/slot_machine_win.ogg" preload="auto"></audio>

  <!-- Ethers.js CDN -->
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

  <script>
    const sobexTokenAddress = "0x99c76e2311ebe008c59226b826c2b96e39e9428b";
    const sobexAbi = [
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    let provider, signer, userAddress;

    const connectWalletBtn = document.getElementById("connectWallet");
    const spinButton = document.getElementById("spinButton");
    const spinResultDisplay = document.getElementById("spinResult");
    const walletAddressDisplay = document.getElementById("walletAddress");
    const redLight = document.getElementById("redLight");
    const spinSound = document.getElementById("spinSound");
    const winSound = document.getElementById("winSound");
    const lever = document.getElementById("lever");
    const leverArm = lever.querySelector(".lever-arm");

    // Connect Wallet
    connectWalletBtn.onclick = async () => {
      if (window.ethereum) {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          walletAddressDisplay.innerText = `Connected: ${userAddress}`;
        } catch (err) {
          alert("Wallet connection failed: " + err.message);
        }
      } else {
        alert("MetaMask not detected!");
      }
    };

    // Helper to flash red light on win
    function flashRedLight(times = 3, duration = 300) {
      let count = 0;
      redLight.classList.add("active");
      const interval = setInterval(() => {
        redLight.classList.toggle("active");
        count++;
        if (count >= times * 2) {
          clearInterval(interval);
          redLight.classList.remove("active");
        }
      }, duration);
    }

    // Spin Logic
    async function spin() {
      if (!userAddress) {
        alert("Connect your wallet first!");
        return;
      }

      try {
        // Play spin sound
        spinSound.currentTime = 0;
        spinSound.play();

        // Simulate spin with delay for better feel
        spinResultDisplay.textContent = "...SPINNING...";
        await new Promise(r => setTimeout(r, 1500));

        // Call your backend API for spin result
        const response = await fetch('/api/spin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: userAddress })
        });

        if (!response.ok) throw new Error("Spin failed!");

        const data = await response.json();

        spinResultDisplay.textContent = data.result.join(" | ");

        // Check for win (all three equal)
        const isWin = data.result[0] === data.result[1] && data.result[1] === data.result[2];

        if (isWin) {
          // Play win sound
          winSound.currentTime = 0;
          winSound.play();

          // Flash blinking red light
          flashRedLight();

          // Send tokens
          const sobexContract = new ethers.Contract(sobexTokenAddress, sobexAbi, signer);
          const decimals = await sobexContract.decimals();
          const rewardAmount = ethers.utils.parseUnits("10", decimals);

          const tx = await sobexContract.transfer(userAddress, rewardAmount);
          await tx.wait();

          alert("Congrats! You won 10 SOBEX!");
        } else {
          alert("No match. Try again!");
        }

      } catch (error) {
        console.error(error);
        alert("Spin error: " + error.message);
      }
    }

    spinButton.addEventListener("click", spin);

    // Lever triggers the spin button click
    lever.addEventListener("mousedown", () => {
      leverArm.classList.add("lever-pulled");
    });
    lever.addEventListener("mouseup", () => {
      leverArm.classList.remove("lever-pulled");
      spinButton.click();
    });
    lever.addEventListener("mouseleave", () => {
      leverArm.classList.remove("lever-pulled");
    });
  </script>
</body>
</html>
