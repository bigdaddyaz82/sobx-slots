<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SOBEX Slot Game</title>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #eee; margin: 0; padding: 0; }
  header, footer { background: #222; padding: 1em; text-align: center; }
  main { padding: 1em; max-width: 600px; margin: auto; }
  .slot-machine { display: flex; justify-content: center; margin: 1em 0; }
  .slot { width: 80px; height: 80px; margin: 0 5px; border: 3px solid #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3em; background: #333; }
  .controls { text-align: center; margin: 1em 0; }
  button { padding: 0.6em 1.2em; font-size: 1.2em; border: none; border-radius: 6px; cursor: pointer; background: #28a745; color: white; }
  button:disabled { background: #555; cursor: default; }
  .message { margin: 1em 0; font-size: 1.1em; }
  .balance, .wallet-address { font-weight: bold; margin-top: 0.5em; }
  #connectBtn { background: #007bff; }
  #disconnectBtn { background: #dc3545; margin-left: 10px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
</head>
<body>

<header>
  <h1>SOBEX Slot Game</h1>
  <p>Bet your SOBEX and win big!</p>
</header>

<main>
  <div>
    <button id="connectBtn">Connect Wallet</button>
    <button id="disconnectBtn" style="display:none;">Disconnect</button>
    <div class="wallet-address" id="walletAddress">Wallet: Not connected</div>
    <div class="balance">Balance: <span id="balance">0</span> SOBEX</div>
  </div>

  <div class="slot-machine" id="slot-machine">
    <div class="slot" id="slot1">?</div>
    <div class="slot" id="slot2">?</div>
    <div class="slot" id="slot3">?</div>
  </div>

  <div class="controls">
    <label for="betAmount">Bet Amount: </label>
    <input type="number" id="betAmount" min="1" max="1000" value="10" />
    <button id="spinBtn" disabled>Spin</button>
  </div>

  <div class="message" id="message"></div>

  <div class="daily-login" style="margin-top:1em;">
    Daily Login Bonus: <button id="claimBonusBtn" disabled>Claim 25 SOBEX</button>
  </div>

  <div class="weekend-bonus" style="margin-top: 1em; font-style: italic; color: #ff0;">
    Weekend Special: Double your winnings on Saturdays and Sundays!
  </div>
</main>

<footer>
  <p>Reynolds Painting and Resurfacing LLC</p>
  <p>Painting Perfection One Surface at a Time.</p>
</footer>

<script>
  const symbols = ["ðŸŽ", "ðŸŒ", "ðŸ‡", "ðŸ’", "ðŸ‰", "ðŸ¥", "ðŸ", "ðŸ¥­", "ðŸ‘", "ðŸ“", "ðŸ¥¥", "ðŸ‹", "ðŸŠ"];

  // Your actual deployed SOBEX token contract address and ABI
  const SOBEX_TOKEN_ADDRESS = "0x99c76e2311ebe008c59226b826c2b96e39e9428b";
  const SOBEX_TOKEN_ABI = [
    {
      "constant":true,
      "inputs":[{"name":"_owner","type":"address"}],
      "name":"balanceOf",
      "outputs":[{"name":"balance","type":"uint256"}],
      "type":"function"
    },
    {
      "constant":false,
      "inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],
      "name":"transfer",
      "outputs":[{"name":"","type":"bool"}],
      "type":"function"
    },
    {
      "constant":true,
      "inputs":[],
      "name":"decimals",
      "outputs":[{"name":"","type":"uint8"}],
      "type":"function"
    }
  ];

  let web3;
  let provider;
  let accounts = [];
  let sobexContract;
  let userBalance = 0;
  let decimals = 18;

  const connectBtn = document.getElementById("connectBtn");
  const disconnectBtn = document.getElementById("disconnectBtn");
  const walletAddressEl = document.getElementById("walletAddress");
  const balanceEl = document.getElementById("balance");
  const spinBtn = document.getElementById("spinBtn");
  const betAmountInput = document.getElementById("betAmount");
  const messageEl = document.getElementById("message");
  const claimBonusBtn = document.getElementById("claimBonusBtn");
  const slotEls = [document.getElementById("slot1"), document.getElementById("slot2"), document.getElementById("slot3")];

  // Store daily bonus claim timestamp locally per wallet
  function getDailyBonusKey() {
    return 'dailyBonusClaim_' + accounts[0];
  }

  function hasClaimedToday() {
    const lastClaim = localStorage.getItem(getDailyBonusKey());
    if (!lastClaim) return false;
    const lastDate = new Date(parseInt(lastClaim));
    const now = new Date();
    return now.toDateString() === lastDate.toDateString();
  }

  function setClaimedToday() {
    localStorage.setItem(getDailyBonusKey(), Date.now().toString());
  }

  async function fromWei(amount, decimals) {
    return amount / (10 ** decimals);
  }

  function toWei(amount, decimals) {
    return Math.floor(amount * (10 ** decimals));
  }

  async function connectWallet() {
    try {
      provider = new WalletConnectProvider.default({
        rpc: {
          8453: "https://mainnet.base.org"
        }
      });

      await provider.enable();
      web3 = new Web3(provider);
      accounts = await web3.eth.getAccounts();

      if (accounts.length === 0) throw new Error("No accounts found");

      sobexContract = new web3.eth.Contract(SOBEX_TOKEN_ABI, SOBEX_TOKEN_ADDRESS);
      decimals = await sobexContract.methods.decimals().call();

      walletAddressEl.textContent = "Wallet: " + accounts[0];
      connectBtn.style.display = "none";
      disconnectBtn.style.display = "inline-block";
      spinBtn.disabled = false;
      claimBonusBtn.disabled = hasClaimedToday();

      await updateUserBalance();

      provider.on("disconnect", () => {
        disconnectWallet();
      });

      messageEl.textContent = "Wallet connected. Ready to play.";
    } catch (err) {
      messageEl.textContent = "Failed to connect wallet: " + err.message;
    }
  }

  function disconnectWallet() {
    if (provider) {
      provider.disconnect();
      provider = null;
      web3 = null;
      accounts = [];
      sobexContract = null;
    }
    walletAddressEl.textContent = "Wallet: Not connected";
    connectBtn.style.display = "inline-block";
    disconnectBtn.style.display = "none";
    spinBtn.disabled = true;
    claimBonusBtn.disabled = true;
    balanceEl.textContent = "0";
    messageEl.textContent = "Wallet disconnected.";
  }

  async function updateUserBalance() {
    if (!sobexContract || accounts.length === 0) return;
    try {
      const balanceRaw = await sobexContract.methods.balanceOf(accounts[0]).call();
      userBalance = await fromWei(balanceRaw, decimals);
      balanceEl.textContent = userBalance.toFixed(4);
    } catch (err) {
      messageEl.textContent = "Error fetching balance: " + err.message;
    }
  }

  function spinResult() {
    let result = [];
    for (let i = 0; i < 3; i++) {
      const idx = Math.floor(Math.random() * symbols.length);
      result.push(symbols[idx]);
    }
    return result;
  }

  // Calculate winnings based on result array and bet
  // Simple rule: if all three match, win 5x bet; if two match, win 2x bet; else lose bet
  function calculateWinnings(results, bet) {
    const [a, b, c] = results;
    let winnings = 0;
    if (a === b && b === c) {
      winnings = bet * 5;
    } else if (a === b || b === c || a === c) {
      winnings
<script>
  // Continue calculateWinnings
  function calculateWinnings(results, bet) {
    const [a, b, c] = results;
    let winnings = 0;
    if (a === b && b === c) {
      winnings = bet * 5;
    } else if (a === b || b === c || a === c) {
      winnings = bet * 2;
    }
    // Weekend bonus
    const day = new Date().getDay();
    const isWeekend = (day === 0 || day === 6); // Sunday=0, Saturday=6
    if (isWeekend) winnings *= 2;
    return winnings;
  }

  async function sendTokens(to, amount) {
    try {
      const amountWei = toWei(amount, decimals);
      await sobexContract.methods.transfer(to, amountWei).send({ from: accounts[0] });
    } catch (err) {
      throw new Error("Transfer failed: " + err.message);
    }
  }

  async function spinSlots() {
    messageEl.textContent = "";
    const bet = parseFloat(betAmountInput.value);
    if (isNaN(bet) || bet <= 0 || bet > userBalance) {
      messageEl.textContent = "Invalid bet amount.";
      return;
    }

    try {
      // Deduct bet
      await sendTokens(SOBEX_TOKEN_ADDRESS, bet); // Send to your game treasury

      const result = spinResult();
      slotEls.forEach((slot, i) => slot.textContent = result[i]);

      const winnings = calculateWinnings(result, bet);
      if (winnings > 0) {
        await sendTokens(accounts[0], winnings);
        messageEl.textContent = `You won ${winnings} SOBEX!`;
      } else {
        messageEl.textContent = "No match. Try again!";
      }

      await updateUserBalance();
    } catch (err) {
      messageEl.textContent = err.message;
    }
  }

  spinBtn.addEventListener("click", spinSlots);

  claimBonusBtn.addEventListener("click", async () => {
    try {
      const bonusAmount = 25;
      await sendTokens(accounts[0], bonusAmount);
      setClaimedToday();
      claimBonusBtn.disabled = true;
      messageEl.textContent = "Daily bonus claimed!";
      await updateUserBalance();
    } catch (err) {
      messageEl.textContent = "Bonus claim failed: " + err.message;
    }
  });

  connectBtn.addEventListener("click", connectWallet);
  disconnectBtn.addEventListener("click", disconnectWallet);
</script>
