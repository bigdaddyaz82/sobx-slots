<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Carnival - Connect Wallet</title>
</head>
<body>
  <h1>Welcome to the Crypto Carnival!</h1>
  <button id="connectButton">Connect MetaMask Wallet</button>
  
  <p id="walletAddress">Not connected</p>
  <p id="rewardMessage"></p>

  <script src="frontend.js"></script>
</body>
</html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOBEX Slots - Old School Style</title>
  <style>
    body {
      background: #222;
      font-family: 'Courier New', Courier, monospace;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .slot-machine {
      position: relative;
      width: 320px;
      background: #444;
      border: 5px solid #aaa;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 20px #f00 inset;
    }
    /* Red blinking light on top */
    .red-light {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      background: red;
      border-radius: 50%;
      box-shadow: 0 0 15px 5px red;
      opacity: 0.2;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    .red-light.active {
      opacity: 1;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% {opacity: 1;}
      50% {opacity: 0.2;}
    }

    /* Display reels */
    #spinResult {
      font-size: 2.2rem;
      text-align: center;
      margin: 10px 0 20px 0;
      letter-spacing: 1.2rem;
      font-weight: bold;
      font-family: 'Courier New', Courier, monospace;
    }

    /* Buttons container */
    .buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    /* Connect wallet button */
    #connectWallet {
      background: #0077ff;
      color: white;
      border: none;
      padding: 12px 18px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      flex: 1;
      margin-right: 10px;
      transition: background 0.3s;
    }
    #connectWallet:hover {
      background: #005bb5;
    }

    /* Big red spin button */
    #spinButton {
      background: #e00;
      color: white;
      border: none;
      padding: 18px 28px;
      font-size: 2rem;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      flex: 1;
      margin-left: 10px;
      box-shadow: 0 0 15px #f00;
      transition: background 0.3s;
    }
    #spinButton:hover {
      background: #a00;
      box-shadow: 0 0 25px #f33;
    }

    /* Lever container */
    .lever-container {
      position: absolute;
      top: 40px;
      right: -70px;
      width: 50px;
      height: 150px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Lever arm */
    .lever-arm {
      background: #bbb;
      width: 12px;
      height: 100px;
      border-radius: 8px;
      box-shadow: inset 0 0 5px #666;
      position: relative;
      transition: transform 0.2s ease;
    }
    /* Lever knob */
    .lever-knob {
      background: #c33;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-top: -20px;
      box-shadow: 0 0 8px #f00;
    }

    /* Lever pull animation */
    .lever-pulled {
      transform: rotate(45deg);
      transition: transform 0.2s ease;
    }

    /* Wallet address display */
    #walletAddress {
      margin-top: 10px;
      font-size: 0.9rem;
      font-family: monospace;
      min-height: 1.3rem;
    }
  </style>
</head>
<body>

  <div class="slot-machine">
    <div class="red-light" id="redLight"></div>

    <div id="spinResult">- - -</div>

    <div class="buttons">
      <button id="connectWallet">Connect Wallet</button>
      <button id="spinButton">SPIN</button>
    </div>

    <div id="walletAddress"></div>

    <div class="lever-container" id="lever" title="Pull lever to spin">
      <div class="lever-arm"></div>
      <div class="lever-knob"></div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="spinSound" src="https://actions.google.com/sounds/v1/casino/slot_machine_spin.ogg" preload="auto"></audio>
  <audio id="winSound" src="https://actions.google.com/sounds/v1/casino/slot_machine_win.ogg" preload="auto"></audio>

  <!-- Ethers.js CDN -->
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

    <script>
    // Your existing constants for SOBEX token (used later in spin)
    const sobexTokenAddress = "0x99c76e2311ebe008c59226b826c2b96e39e9428b";
    const sobexAbi = [
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    // Variables to store ethers objects and user address
    let provider, signer, userAddress;

    // Get DOM elements
    const connectWalletBtn = document.getElementById("connectWallet");
    const spinButton = document.getElementById("spinButton");
    const spinResultDisplay = document.getElementById("spinResult");
    const walletAddressDisplay = document.getElementById("walletAddress");
    const redLight = document.getElementById("redLight");
    const spinSound = document.getElementById("spinSound");
    const winSound = document.getElementById("winSound");
    const lever = document.getElementById("lever");
    const leverArm = lever.querySelector(".lever-arm");

    // --- Connect Wallet Functionality ---
    connectWalletBtn.onclick = async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          // 1. Initialize Ethers.js provider with MetaMask's provider
          provider = new ethers.providers.Web3Provider(window.ethereum);

          // 2. Request account access from MetaMask
          // This will prompt the user to connect their wallet if they haven't already
          await provider.send("eth_requestAccounts", []);

          // 3. Get the signer object
          // A signer is needed to sign transactions (not strictly for getting address, but good practice)
          signer = provider.getSigner();

          // 4. Get the connected wallet address
          userAddress = await signer.getAddress();

          // 5. Update UI to show connected status
          // Display a truncated version of the address for better UI
          walletAddressDisplay.innerText = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          connectWalletBtn.innerText = "Connected";
          connectWalletBtn.disabled = true; // Disable button after successful connection

          // Enable the spin button now that the wallet is connected
          spinButton.disabled = false;

          // **Optional Next Step:** If you want to inform your backend that a wallet connected:
          // fetch('/api/user-connected', {
          //   method: 'POST',
          //   headers: { 'Content-Type': 'application/json' },
          //   body: JSON.stringify({ walletAddress: userAddress })
          // }).then(response => response.json())
          //   .then(data => console.log('Backend notified:', data))
          //   .catch(error => console.error('Error notifying backend:', error));
          // (You would need to create this '/api/user-connected' endpoint on your server.js)

        } catch (error) {
          console.error("Wallet connection error:", error);
          walletAddressDisplay.innerText = "Connection failed. Please try again.";
          if (error.code === 4001) { // User rejected the request
            alert("You rejected the connection request in MetaMask.");
          } else {
            alert("Wallet connection failed: " + error.message);
          }
          // Ensure spin button remains disabled if connection fails
          spinButton.disabled = true;
        }
      } else {
        // MetaMask (or other window.ethereum provider) is not installed
        alert("MetaMask not detected! Please install MetaMask to use this application.");
        walletAddressDisplay.innerText = "MetaMask not detected.";
        spinButton.disabled = true;
      }
    };

    // --- Spin Logic (existing, ensure it checks for userAddress) ---
    async function spin() {
      if (!userAddress || !signer) { // Check if wallet is connected
        alert("Please connect your wallet first to spin!");
        return;
      }

      // ... (rest of your existing spin logic)
      try {
        spinSound.currentTime = 0;
        spinSound.play();
        spinResultDisplay.textContent = "...SPINNING...";
        await new Promise(r => setTimeout(r, 1500));

        const response = await fetch('/api/spin', { // This call is good
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: userAddress }) // Sending userAddress to backend
        });

        if (!response.ok) throw new Error(`Spin request failed: ${response.statusText}`);

        const data = await response.json();
        spinResultDisplay.textContent = data.result.join(" | "); // Assuming backend sends result as an array

        // Backend should ideally determine win and payout.
        // For now, client-side win determination and payout initiation:
        const isWin = data.result.length === 3 && data.result[0] === data.result[1] && data.result[1] === data.result[2];

        if (isWin) {
          winSound.currentTime = 0;
          winSound.play();
          flashRedLight();

          // IMPORTANT: This part will be revised when platform handles payouts.
          // For now, it attempts a client-side transfer from the user's perspective.
          alert("Congrats! You won! Attempting to send reward..."); // Placeholder
          try {
            const sobexContract = new ethers.Contract(sobexTokenAddress, sobexAbi, signer);
            const decimals = await sobexContract.decimals(); // Ensure SOBEX ABI has decimals()
            const rewardAmount = ethers.utils.parseUnits("10", decimals); // Example: 10 tokens

            // This transaction is initiated and paid for by the USER'S connected wallet.
            // In a real casino, the PLATFORM'S wallet would send the reward.
            const tx = await sobexContract.transfer(userAddress, rewardAmount);
            await tx.wait();
            alert("Reward of 10 SOBEX should have been transferred! (Check your wallet and transaction)");
          } catch (tokenError) {
            console.error("Token transfer error:", tokenError);
            alert("Win confirmed, but reward transfer failed: " + tokenError.message);
          }
        } else {
          // No win
        }

      } catch (error) {
        console.error("Spin error:", error);
        spinResultDisplay.textContent = "Spin Error!";
        alert("Spin error: " + error.message);
      }
    }

    spinButton.addEventListener("click", spin);

    // --- Lever functionality (existing) ---
    lever.addEventListener("mousedown", () => {
      leverArm.classList.add("lever-pulled");
    });
    lever.addEventListener("mouseup", () => {
      leverArm.classList.remove("lever-pulled");
      if (!spinButton.disabled) { // Only click spin if it's enabled
        spinButton.click();
      } else {
        alert("Please connect your wallet first!");
      }
    });
    lever.addEventListener("mouseleave", () => { // Ensure lever resets if mouse leaves while pressed
      leverArm.classList.remove("lever-pulled");
    });

    // --- Helper to flash red light (existing) ---
    function flashRedLight(times = 3, duration = 300) {
      let count = 0;
      redLight.classList.remove("active"); // Ensure it's reset before starting
      const interval = setInterval(() => {
        redLight.classList.toggle("active");
        count++;
        if (count >= times * 2) { // Blink on and off for 'times'
          clearInterval(interval);
          redLight.classList.remove("active");
        }
      }, duration);
    }

    // --- Handling Account and Network Changes (Recommended for robustness) ---
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
          // MetaMask is locked or the user has disconnected all accounts
          alert("Wallet disconnected. Please connect again.");
          walletAddressDisplay.innerText = "Disconnected. Please connect.";
          connectWalletBtn.innerText = "Connect Wallet";
          connectWalletBtn.disabled = false;
          spinButton.disabled = true;
          userAddress = null;
          signer = null;
          // provider = null; // Provider might still be valid if MetaMask is just locked
        } else {
          // Account has changed, re-run connection logic for the new account
          userAddress = accounts[0]; // Update to the new address
          // Re-initialize signer for the new account
          if(provider) { // provider should still exist
             signer = provider.getSigner();
          }
          walletAddressDisplay.innerText = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
          connectWalletBtn.innerText = "Connected";
          connectWalletBtn.disabled = true;
          spinButton.disabled = false;
          alert("Account changed to: " + userAddress);
        }
      });

      window.ethereum.on('chainChanged', (chainId) => {
        // Handle chain changes, e.g., reload the page or prompt user to switch to the correct network
        alert(`Network changed to ${chainId}. Please ensure you are on the correct network.`);
        // You might want to reload or re-initialize parts of your app
        window.location.reload();
      });
    }
  </script>
